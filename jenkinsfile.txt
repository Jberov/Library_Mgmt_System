@Library(["piper-lib-os"])_

pipeline {
  agent any
  environment {
    CF_API = "https://api.cf.sap.hana.ondemand.com"
    CF_ORG = "SAC Sofia team_library-managment"
    CF_SPACE = "LibraryApp"
  }
  stages {
    stage("Setup") {
        steps {
            deleteDir()
            checkout master
            setupPipelineEnvironment script: this
        }
    }

    stage("Build") {
      steps {
               {
          sh "
            maven clean install
          "
        }
      }
    }

    stage("Deploy") {
      when {
        branch "main"
      }
      steps {
        withCredentials([usernamePassword(credentialsId: "BookAppCreds", usernameVariable: "CF_USER", passwordVariable: "CF_PASS")]) {
          dockerExecute(script: this, dockerImage: "ppiper/cf-cli:v8") {
            sh "
              cf login -a $CF_API -u $CF_USER -p $CF_PASS -o '$CF_ORG' -s '$CF_SPACE'
              cf push -f manifest.yml
            "
          }
        }
      }
    }
  }
}